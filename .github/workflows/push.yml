name: Push request

on:
  pull_request:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@main
      - name: Run tests
        run: make test
      - name: Upload results to Codecov
        uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: true # optional (default = false)
          flags: unittests # optional
          verbose: true # optional (default = false)
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  e2e:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@main
#      - name: Build binary
#        run: |
#          whoami
#          sudo whoami
#          make build
#          mv ./k8spacket ./tests/e2e/vm/
      - name: Install qemu & friends
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-utils qemu-system-x86
      - name: Run e2e tests on kernel 5.15
        run: |
          cd ./tests/e2e/vm/
          unzip filesystem.zip
          sudo qemu-img create -f qcow2 -b filesystem.qcow2 -F qcow2 filesystem-diff.qcow2
          sudo qemu-system-x86_64 \
          -cpu host \
          -m 4G \
          -smp 4 \
          -kernel ./5.15/bzImage \
          -append "console=ttyS0 root=/dev/sda rw" \
          -drive file=filesystem-diff.qcow2,format=qcow2 \
          -net nic -net user,hostfwd=tcp::10022-:22,hostfwd=tcp::16676-:6676,hostfwd=tcp::10443-:443 \
          -enable-kvm \
          -nographic > qemu.log 2>&1 & 
          
          wget -q -O - --no-check-certificate https://localhost:10443
          sleep(5)
          wget -q -O - --no-check-certificate https://localhost:10443
          sleep(5)
          wget -q -O - --no-check-certificate https://localhost:10443
          sleep(5)
          wget -q -O - --no-check-certificate https://localhost:10443